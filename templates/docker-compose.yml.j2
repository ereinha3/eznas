{% set paths = config.paths %}
{% set services = config.services %}
{% set runtime = config.runtime %}
{% set scratch_host = paths.scratch if paths.scratch else paths.pool ~ "/downloads" %}
{% set proxy = config.proxy %}
{% set traefik_tls_enabled = proxy.https_port is not none %}
{% set traefik_entrypoint = "websecure" if traefik_tls_enabled else "web" %}
services:
{% if proxy.enabled %}
  traefik:
    image: {{ proxy.image }}
    container_name: traefik
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
{% if traefik_tls_enabled %}
      - "--entrypoints.websecure.address=:443"
{% endif %}
{% if proxy.dashboard %}
      - "--api.dashboard=true"
      - "--api.insecure=true"
{% endif %}
{% for arg in proxy.additional_args %}
      - "{{ arg }}"
{% endfor %}
    ports:
      - "{{ proxy.http_port }}:80"
{% if traefik_tls_enabled %}
      - "{{ proxy.https_port }}:443"
{% endif %}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - {{ paths.appdata }}/traefik:/config
    networks:
      - nas_net
{% endif %}
{% if services.qbittorrent.enabled %}
  qbittorrent:
    image: {{ config.get("images", {}).get("qbittorrent", "lscr.io/linuxserver/qbittorrent:latest") }}
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      - PUID={{ runtime.user_id }}
      - PGID={{ runtime.group_id }}
      - TZ={{ runtime.timezone }}
    volumes:
      - {{ paths.appdata }}/qbittorrent:/config
      - {{ scratch_host }}:/downloads
      - {{ paths.pool }}:/data
{% if services.qbittorrent.port %}
    ports:
      - "{{ services.qbittorrent.port }}:8080"
{% endif %}
{% if services.qbittorrent.proxy_url %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbittorrent.rule=Host(`{{ services.qbittorrent.proxy_url }}`)"
      - "traefik.http.routers.qbittorrent.entrypoints={{ traefik_entrypoint }}"
{% if traefik_tls_enabled %}
      - "traefik.http.routers.qbittorrent.tls=true"
{% endif %}
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"
{% endif %}
    networks:
      - nas_net
{% endif %}

{% if services.radarr.enabled %}
  radarr:
    image: {{ config.get("images", {}).get("radarr", "lscr.io/linuxserver/radarr:latest") }}
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID={{ runtime.user_id }}
      - PGID={{ runtime.group_id }}
      - TZ={{ runtime.timezone }}
    volumes:
      - {{ paths.appdata }}/radarr:/config
      - {{ paths.pool }}:/data
      - {{ scratch_host }}:/downloads
{% if services.radarr.port %}
    ports:
      - "{{ services.radarr.port }}:7878"
{% endif %}
{% if services.radarr.proxy_url %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`{{ services.radarr.proxy_url }}`)"
      - "traefik.http.routers.radarr.entrypoints={{ traefik_entrypoint }}"
{% if traefik_tls_enabled %}
      - "traefik.http.routers.radarr.tls=true"
{% endif %}
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
{% endif %}
    depends_on:
{% if services.qbittorrent.enabled %}
      - qbittorrent
{% endif %}
    networks:
      - nas_net
{% endif %}

{% if services.sonarr.enabled %}
  sonarr:
    image: {{ config.get("images", {}).get("sonarr", "lscr.io/linuxserver/sonarr:latest") }}
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID={{ runtime.user_id }}
      - PGID={{ runtime.group_id }}
      - TZ={{ runtime.timezone }}
    volumes:
      - {{ paths.appdata }}/sonarr:/config
      - {{ paths.pool }}:/data
      - {{ scratch_host }}:/downloads
{% if services.sonarr.port %}
    ports:
      - "{{ services.sonarr.port }}:8989"
{% endif %}
{% if services.sonarr.proxy_url %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`{{ services.sonarr.proxy_url }}`)"
      - "traefik.http.routers.sonarr.entrypoints={{ traefik_entrypoint }}"
{% if traefik_tls_enabled %}
      - "traefik.http.routers.sonarr.tls=true"
{% endif %}
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
{% endif %}
    depends_on:
{% if services.qbittorrent.enabled %}
      - qbittorrent
{% endif %}
    networks:
      - nas_net
{% endif %}

{% if services.prowlarr.enabled %}
  prowlarr:
    image: {{ config.get("images", {}).get("prowlarr", "lscr.io/linuxserver/prowlarr:latest") }}
    container_name: prowlarr
    restart: unless-stopped
    environment:
      - PUID={{ runtime.user_id }}
      - PGID={{ runtime.group_id }}
      - TZ={{ runtime.timezone }}
    volumes:
      - {{ paths.appdata }}/prowlarr:/config
{% if services.prowlarr.port %}
    ports:
      - "{{ services.prowlarr.port }}:9696"
{% endif %}
{% if services.prowlarr.proxy_url %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`{{ services.prowlarr.proxy_url }}`)"
      - "traefik.http.routers.prowlarr.entrypoints={{ traefik_entrypoint }}"
{% if traefik_tls_enabled %}
      - "traefik.http.routers.prowlarr.tls=true"
{% endif %}
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
{% endif %}
    networks:
      - nas_net
{% endif %}

{% if services.jellyseerr.enabled %}
  jellyseerr:
    image: {{ config.get("images", {}).get("jellyseerr", "fallenbagel/jellyseerr:latest") }}
    container_name: jellyseerr
    restart: unless-stopped
    environment:
      - LOG_LEVEL=info
      - TZ={{ runtime.timezone }}
    volumes:
      - {{ paths.appdata }}/jellyseerr:/app/config
{% if services.jellyseerr.port %}
    ports:
      - "{{ services.jellyseerr.port }}:5055"
{% endif %}
{% if services.jellyseerr.proxy_url %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyseerr.rule=Host(`{{ services.jellyseerr.proxy_url }}`)"
      - "traefik.http.routers.jellyseerr.entrypoints={{ traefik_entrypoint }}"
{% if traefik_tls_enabled %}
      - "traefik.http.routers.jellyseerr.tls=true"
{% endif %}
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
{% endif %}
    depends_on:
{% if services.radarr.enabled %}
      - radarr
{% endif %}
{% if services.sonarr.enabled %}
      - sonarr
{% endif %}
{% if services.jellyfin.enabled %}
      - jellyfin
{% endif %}
    networks:
      - nas_net
{% endif %}

{% if services.jellyfin.enabled %}
  jellyfin:
    image: {{ config.get("images", {}).get("jellyfin", "lscr.io/linuxserver/jellyfin:latest") }}
    container_name: jellyfin
    restart: unless-stopped
    environment:
      - PUID={{ runtime.user_id }}
      - PGID={{ runtime.group_id }}
      - TZ={{ runtime.timezone }}
    volumes:
      - {{ paths.appdata }}/jellyfin:/config
      - {{ scratch_host }}/transcode:/transcode
      - {{ paths.pool }}:/data
{% if services.jellyfin.port %}
    ports:
      - "{{ services.jellyfin.port }}:8096"
{% endif %}
{% if services.jellyfin.proxy_url %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`{{ services.jellyfin.proxy_url }}`)"
      - "traefik.http.routers.jellyfin.entrypoints={{ traefik_entrypoint }}"
{% if traefik_tls_enabled %}
      - "traefik.http.routers.jellyfin.tls=true"
{% endif %}
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
{% endif %}
    networks:
      - nas_net
{% endif %}

{% if services.pipeline.enabled %}
  pipeline-worker:
    image: nas_orchestrator-orchestrator:latest
    container_name: pipeline-worker
    restart: unless-stopped
    environment:
      - TZ={{ runtime.timezone }}
      - ORCH_ROOT=/config
      - PIPELINE_INTERVAL={{ services.pipeline.interval | default(60) }}
    command: ["python", "-m", "orchestrator.pipeline.runner"]
    volumes:
      - {{ paths.pool }}:/data
      # Match qBittorrent's internal save paths (it reports /downloads/... via API).
      - {{ scratch_host }}:/downloads
{% if config_host_path %}
      # Dev mode: bind mount to host config directory
      - {{ config_host_path }}/stack.yaml:/config/stack.yaml:ro
      - {{ config_host_path }}/state.json:/config/state.json
{% else %}
      # Production mode: use shared volume (needs write access for state.json)
      - orchestrator_config:/config
{% endif %}
    depends_on:
{% if services.qbittorrent.enabled %}
      - qbittorrent
{% endif %}
    networks:
      - nas_net
{% endif %}

networks:
  nas_net:
    driver: bridge

{% if services.pipeline.enabled and not config_host_path %}
volumes:
  orchestrator_config:
{% endif %}
